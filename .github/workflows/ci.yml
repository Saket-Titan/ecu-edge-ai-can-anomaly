name: Build Firmware & Tests

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: application

      - name: Pull Zephyr Docker Image
        run: docker pull ghcr.io/zephyrproject-rtos/zephyr-build:latest

      - name: Build Firmware in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workdir \
            -w /workdir \
            ghcr.io/zephyrproject-rtos/zephyr-build:latest \
            /bin/bash -c "
              # Initialize Zephyr Workspace
              west init -l application &&
              west update &&
              west zephyr-export &&

              # Build Project A: Engine ECU
              echo 'Building Engine ECU...' &&
              west build -p always -b nucleo_g474re application/firmware/ecu_engine &&

              # Build Project B: IDS Node (Sysbuild)
              echo 'Building IDS Node...' &&
              west build --sysbuild -p always -b nucleo_h723zg application/firmware/ids_node &&

              # Build Unit Tests
              echo 'Building Unit Tests...' &&
              west build -p always -b nucleo_h723zg application/tests/unit/anomaly_score
            "
